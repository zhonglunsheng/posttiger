import{g as H,a as oe,b as ne,c as Ie,s as Ke,d as Ee,u as R,e as Ne}from"./db.js";import{B as Be,r as Ae}from"./vue3-form-element.esm.min.js";import{r as C,a as p,c as je,u as De,w as Je,o as Le,b as Pe,d as h,e as d,f as I,g as _,h as l,i as s,j as S,k as n,l as y,n as m,F as M,p as f,q as le,s as K,_ as E,E as k,v as V}from"./index.js";const Re={class:"box-card",style:{"margin-top":"10px"}},ze={class:"margin-top"},Oe=_("br",null,null,-1),Ue={key:0},qe={key:1},He={key:0,style:{height:"70vh"}},Me={style:{height:"50vh",width:"100%","margin-top":"10px","margin-bottom":"5px"}},Ve={style:{height:"50vh",width:"100%","margin-top":"10px","margin-bottom":"5px"}},Ge={style:{height:"50vh",width:"100%","margin-top":"10px","margin-bottom":"5px"}},Qe={style:{height:"80vh"}},Xe={key:0,style:{height:"50vh","margin-top":"10px","margin-bottom":"5px"}},tt={__name:"index",setup(Ye){var X,Y,Z,$;let D=C(H()),N=p("");const ae=je(()=>{let t=N.value,e=[];return t||(e=[...D]),e=D.filter(a=>!!(a.basicForm&&a.basicForm.name&&a.basicForm.name.includes(t)||a.basicForm&&a.basicForm.codeType&&a.basicForm.codeType.includes(t)||a.basicForm&&a.basicForm.desc&&a.basicForm.desc.includes(t))),e.sort((a,c)=>{let L=a.updateTime||0;return(c.updateTime||0)-L}),e});let se=De();const z=()=>{se.push("/redirect")};let i={isAdd:!1,isEdit:!1,editItemInfo:{}};const ie=t=>{let e=JSON.parse(JSON.stringify(t));g.value=!0,i.isEdit=!1,i.isAdd=!0,u=(e==null?void 0:e.basicForm)||{},r={hostKey:e.features?JSON.stringify(e.features,null,2):e.features,code:e.code},u.name=u.name+"_copy"},re=t=>{g.value=!0,i.isEdit=!0,i.editItemInfo={...t},u=(t==null?void 0:t.basicForm)||{},r={id:t.id,hostKey:t.features?JSON.stringify(t.features,null,2):t.features,code:t.code,preScriptContent:t.preScriptContent,createTime:t.createTime}},de=t=>{g.value=!0,i.isAdd=!0,u={},r={hostKey:"",code:""}},ce=t=>{let e=H();e=e.filter(a=>a.basicForm.name!==t.basicForm.name),R([...e]),z()};let T=p(!1),x=p(""),b=p(""),w=p(""),ue=C(oe()),O=p(!0);const pe=()=>{T.value=!0,x.value="",b.value=""},me=()=>{Ke(x.value,b.value),k.success("新增自定义函数成功"),T.value=!1,w.value=""},fe=t=>{w.value=t,x.value=t,b.value=oe()[t],console.log(b),O.value=!1,setTimeout(()=>{O.value=!0},100)};let g=p(!1),r=C({hostKey:"",code:"",preScriptContent:""}),J=p("javascript");const ge=t=>{r.code=t},ye=t=>{r.hostKey=t};C({show:!1,okBtn:"保存",okBtnProps:{type:"primary"},cancelBtn:"取消",formItemAttrs:{}});let ve=C(ne().formProps),u=C({});const _e=C(ne().basicSchema),he=()=>{console.log("basicForm",u);let t={basicForm:u,features:r.hostKey,code:r.code,preScriptContent:r.preScriptContent,...r,updateTime:new Date().getTime()};if(console.log("dataItem",t),r.hostKey&&(t.features=JSON.parse(r.hostKey)),i.isAdd){if(Ee(u.name)){k.error("当前脚本名称存在，请勿重复添加！！");return}t.createTime=new Date().getTime(),t.id=V.util.getScriptNextId(),D.push(t),R([...D]),k.success("添加成功")}else if(i.isEdit){let e=H(),a=i.editItemInfo;if(a.basicForm.name!==t.basicForm.name)e=e.filter(c=>c.basicForm.name!==a.basicForm.name),e.push(t),R([...e]);else for(let c=0;c<e.length;c++)e[c].basicForm.name==t.basicForm.name&&(e[c]={...t});R([...e]),Se(),k.success("更新成功")}window.services.sandbox.registerHotKey()},be=()=>{g.value=!1,z()},G=p(!1),Fe=({oldValue:t,newValue:e,type:a})=>{setTimeout(()=>{e&&e.codeType&&J.value!=e.codeType&&(J.value=e.codeType),G.value=!0},50),v.debugWindow=e==null?void 0:e.debugWindow,v.apiWindow=e==null?void 0:e.apiWindow,v.hotKeyWindow=e==null?void 0:e.hotKeyWindow,v.preScriptWindow=e==null?void 0:e.preScriptWindow},B=p(""),W=p("true"),Ce=()=>{if(u.codeType==="javascript"){let t=window.services.sandBox(r.code);console.log(t),B.value=typeof t=="object"?JSON.stringify(t):t+"",W.value=!1,setTimeout(()=>{W.value=!0},200)}else u.codeType==="python"&&window.services.PythonShell.runString(r.code,null).then(t=>{k.success("执行成功"),console.log(t),window.services.saveExecuteResult(t);let e=r.code.match(/"""([\s\S]*?)"""/);if(e){let a=e[1].trim();console.log(a),t=t+`

`+window.services.sandBox(a)}else console.log("未找到匹配的代码块");B.value=typeof t=="object"?JSON.stringify(t):t+"",W.value=!1,setTimeout(()=>{W.value=!0},200),console.log(r.code)}).catch(t=>{console.log(t),k.error("执行失败"),B.value=t+"",W.value=!1,setTimeout(()=>{W.value=!0},200)})};Je(()=>{g.value||(B.value="")});let A=p(Ie("codeApi"));const Se=()=>{Ne("codeApi",t=>A.value)};let ke=p(!0);const U=p(!0),Q=t=>{g&&(U.value=!1,setTimeout(()=>{U.value=!0},10))};Le(()=>{window.addEventListener("resize",Q)}),Pe(()=>{window.removeEventListener("resize",Q)});const v=C({debugWindow:!1,apiWindow:!1,hotKeyWindow:!1,preScriptWindow:!1,postScriptWindow:!1});(X=i==null?void 0:i.editItemInfo)!=null&&X.basicForm&&(v.debugWindow=(Y=i==null?void 0:i.editItemInfo)==null?void 0:Y.basicForm.debugWindow,v.apiWindow=(Z=i==null?void 0:i.editItemInfo)==null?void 0:Z.basicForm.apiWindow,v.hotKeyWindow=($=i==null?void 0:i.editItemInfo)==null?void 0:$.basicForm.hotKeyWindow);const Te=t=>{Ae(t,null,e=>{let a=typeof e=="object"?JSON.stringify(e):e;console.log(a),k.error("运行失败："+a)},()=>{k.info("运行完成")})};return(t,e)=>{const a=h("el-input"),c=h("el-button"),L=h("el-popconfirm"),ee=h("el-card"),F=h("el-col"),P=h("el-row"),j=h("el-divider"),te=h("el-dialog"),xe=h("el-option"),we=h("el-select");return d(),I(M,null,[_("div",Re,[l(a,{modelValue:s(N),"onUpdate:modelValue":e[0]||(e[0]=o=>S(N)?N.value=o:N=o),placeholder:"关键字搜索",clearable:"",style:{width:"200px",margin:"5px"}},null,8,["modelValue"]),l(c,{type:"primary",onClick:de},{default:n(()=>[f("新增脚本")]),_:1}),l(c,{type:"primary",onClick:pe},{default:n(()=>[f("新增函数")]),_:1}),_("div",ze,[l(P,{gutter:20},{default:n(()=>[(d(!0),I(M,null,le(ae.value,(o,We)=>(d(),y(F,{span:12,key:We},{default:n(()=>[l(ee,{style:{"margin-top":"10px"}},{default:n(()=>[l(c,{type:"warning",onClick:q=>re(o)},{default:n(()=>[f("编辑")]),_:2},1032,["onClick"]),l(c,{type:"primary",onClick:q=>ie(o)},{default:n(()=>[f("复制")]),_:2},1032,["onClick"]),l(L,{title:"Are you sure to delete this?",onConfirm:q=>ce(o)},{reference:n(()=>[l(c,{type:"danger"},{default:n(()=>[f("删除")]),_:1})]),_:2},1032,["onConfirm"]),l(c,{type:"success",onClick:q=>Te(o)},{default:n(()=>[f("运行")]),_:2},1032,["onClick"]),Oe,_("p",null,"序号："+K(o.id),1),_("p",null,"名称："+K(o.basicForm.name),1),_("p",null,"描述："+K(o.basicForm.desc),1),_("p",null,"类型："+K(o.basicForm.codeType),1),o.createTime?(d(),I("p",Ue," 创建时间："+K(s(V).util.getDateTimeStr(o.createTime)),1)):m("",!0),o.updateTime?(d(),I("p",qe," 更新时间："+K(s(V).util.getDateTimeStr(o.updateTime)),1)):m("",!0)]),_:2},1024)]),_:2},1024))),128))]),_:1})])]),U.value?(d(),y(te,{key:0,modelValue:s(g),"onUpdate:modelValue":e[5]||(e[5]=o=>S(g)?g.value=o:g=o),fullscreen:!0,onClose:z},{default:n(()=>[l(P,{gutter:20},{default:n(()=>[l(F,{span:18},{default:n(()=>[l(j,{"content-position":"center"},{default:n(()=>[f(K(s(J))+"脚本编写 ",1)]),_:1}),G.value?(d(),I("div",He,[s(g)?(d(),y(E,{key:0,onChangeData:ge,language:s(J),code:s(r).code},null,8,["language","code"])):m("",!0)])):m("",!0),l(P,{gutter:20},{default:n(()=>[v.preScriptWindow?(d(),y(F,{key:0,span:24},{default:n(()=>[l(j,{"content-position":"center"},{default:n(()=>[f("前置脚本")]),_:1}),_("div",Me,[l(E,{onChangeData:e[1]||(e[1]=o=>{s(r).preScriptContent=o}),language:"javascript",code:s(r).preScriptContent},null,8,["code"])])]),_:1})):m("",!0),v.debugWindow?(d(),y(F,{key:1,span:24},{default:n(()=>[l(P,null,{default:n(()=>[l(F,{span:24},{default:n(()=>[l(c,{onClick:Ce,type:"warning",style:{float:"right",margin:"5px"}},{default:n(()=>[f(" 运行调试 ")]),_:1})]),_:1})]),_:1}),_("div",Ve,[W.value?(d(),y(E,{key:0,language:"text",code:B.value},null,8,["code"])):m("",!0)])]),_:1})):m("",!0),v.apiWindow?(d(),y(F,{key:2,span:24},{default:n(()=>[l(j,{"content-position":"center"},{default:n(()=>[f("API文档")]),_:1}),_("div",Ge,[s(ke)?(d(),y(E,{key:0,onChangeData:e[2]||(e[2]=o=>{S(A)?A.value=o:A=o}),language:"text",code:s(A)},null,8,["code"])):m("",!0)]),f(" > ")]),_:1})):m("",!0),v.hotKeyWindow?(d(),y(F,{key:3,span:24},{default:n(()=>[l(j,{"content-position":"center"},{default:n(()=>[f("绑定热key")]),_:1}),_("div",Qe,[s(g)?(d(),y(E,{key:0,onChangeData:ye,language:"json",code:s(r).hostKey},null,8,["code"])):m("",!0)])]),_:1})):m("",!0)]),_:1})]),_:1}),l(F,{span:6},{default:n(()=>[l(j,{"content-position":"center"},{default:n(()=>[f("基础配置")]),_:1}),l(s(Be),{modelValue:s(u),"onUpdate:modelValue":e[3]||(e[3]=o=>S(u)?u.value=o:u=o),schema:_e,onChange:e[4]||(e[4]=o=>Fe(o)),formProps:s(ve),onSubmit:he,onCancel:be},null,8,["modelValue","schema","formProps"])]),_:1})]),_:1})]),_:1},8,["modelValue"])):m("",!0),l(te,{modelValue:s(T),"onUpdate:modelValue":e[9]||(e[9]=o=>S(T)?T.value=o:T=o),fullscreen:!0},{default:n(()=>[l(a,{placeholder:"函数名称",modelValue:s(x),"onUpdate:modelValue":e[6]||(e[6]=o=>S(x)?x.value=o:x=o),style:{width:"200px","margin-right":"10px"},disabled:s(w)!==""},null,8,["modelValue","disabled"]),l(we,{modelValue:s(w),"onUpdate:modelValue":e[7]||(e[7]=o=>S(w)?w.value=o:w=o),placeholder:"选中要修改的函数",size:"large",onChange:fe,clearable:""},{default:n(()=>[(d(!0),I(M,null,le(Object.keys(s(ue)),o=>(d(),y(xe,{key:o,label:o,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(O)?(d(),I("div",Xe,[s(T)?(d(),y(E,{key:0,onChangeData:e[8]||(e[8]=o=>{S(b)?b.value=o:b=o}),language:"javascript",code:s(b)},null,8,["code"])):m("",!0)])):m("",!0),l(c,{onClick:me,type:"primary"},{default:n(()=>[f("保存")]),_:1})]),_:1},8,["modelValue"])],64)}}};export{tt as default};
